# SSH è¿æ¥æ±  - æ™ºèƒ½è¿æ¥å¤ç”¨ä¸è‡ªåŠ¨é‡è¿

> é€šè¿‡å¼•ç”¨è®¡æ•°å’Œå¿ƒè·³æœºåˆ¶å®ç°çš„é«˜æ•ˆ SSH è¿æ¥æ± ï¼Œæ”¯æŒå¤šä¼šè¯å…±äº«ã€è‡ªåŠ¨é‡è¿å’Œç©ºé—²ç®¡ç†ã€‚

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

SSH è¿æ¥æ± æ˜¯ OxideTerm çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œå®ƒå…è®¸å¤šä¸ªç»ˆç«¯çª—å£ã€SFTP ä¼šè¯å’Œç«¯å£è½¬å‘è§„åˆ™å…±äº«åŒä¸€ä¸ªç‰©ç† SSH è¿æ¥ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± ï¼Ÿ

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š
- æ¯ä¸ªç»ˆç«¯çª—å£å»ºç«‹ç‹¬ç«‹çš„ SSH è¿æ¥
- é‡å¤çš„æ¡æ‰‹å’Œè®¤è¯è¿‡ç¨‹ï¼ˆæµªè´¹æ—¶é—´å’Œèµ„æºï¼‰
- æœåŠ¡å™¨å¯èƒ½é™åˆ¶åŒæ—¶è¿æ¥æ•°
- ç½‘ç»œæŠ–åŠ¨æ—¶æ‰€æœ‰è¿æ¥åŒæ—¶æ–­å¼€

**è¿æ¥æ± çš„ä¼˜åŠ¿**ï¼š
- âœ… **è¿æ¥å¤ç”¨**ï¼šä¸€æ¬¡æ¡æ‰‹ï¼Œå¤šä¸ªä¼šè¯å…±äº«
- âœ… **æ™ºèƒ½é‡è¿**ï¼šæ–­çº¿åè‡ªåŠ¨é‡å»ºï¼Œå¯¹ç”¨æˆ·é€æ˜
- âœ… **èµ„æºé«˜æ•ˆ**ï¼šå‡å°‘æœåŠ¡å™¨è´Ÿè½½å’Œç½‘ç»œå¼€é”€
- âœ… **ä¼˜é›…é™çº§**ï¼šå¿ƒè·³å¤±è´¥æ—¶è¿›å…¥ä¿æŠ¤æ¨¡å¼

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SshConnectionRegistry (è¿æ¥æ± )                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ConnectionEntry (å•ä¸ª SSH è¿æ¥)                       â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ HandleController (å…‹éš†ç»™æ¶ˆè´¹è€…)                   â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ config: SessionConfig                             â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ ref_count: AtomicU32 (å¼•ç”¨è®¡æ•°)                   â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ state: ConnectionState                            â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ heartbeat_task: å¿ƒè·³æ£€æµ‹ (15s é—´éš”)               â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ reconnect_task: é‡è¿ä»»åŠ¡ (æŒ‡æ•°é€€é¿)               â”‚  â”‚
â”‚  â”‚  â””â”€â”€ idle_timer: ç©ºé—²è¶…æ—¶ (é»˜è®¤ 30 åˆ†é’Ÿ)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚  HandleController (clone)
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼           â–¼             â–¼             â–¼
Terminal   Terminal      SFTP       Port Forward
 Tab 1      Tab 2
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ |
|------|------|
| **SshConnectionRegistry** | å…¨å±€è¿æ¥æ± ï¼Œç®¡ç†æ‰€æœ‰ SSH è¿æ¥ |
| **ConnectionEntry** | å•ä¸ª SSH è¿æ¥çš„å°è£…ï¼ŒåŒ…å«çŠ¶æ€å’Œå…ƒæ•°æ® |
| **HandleController** | å¯å…‹éš†çš„å¥æŸ„ï¼Œç”¨äºåœ¨è¿æ¥ä¸Šå¼€å¯æ–° channel |
| **ref_count** | åŸå­å¼•ç”¨è®¡æ•°ï¼Œè¿½è¸ªè¿æ¥çš„ä½¿ç”¨è€…æ•°é‡ |
| **heartbeat_task** | å¿ƒè·³æ£€æµ‹ä»»åŠ¡ï¼Œç›‘æ§è¿æ¥å¥åº·çŠ¶å†µ |
| **reconnect_task** | é‡è¿ä»»åŠ¡ï¼Œæ–­çº¿åè‡ªåŠ¨æ¢å¤ |
| **idle_timer** | ç©ºé—²è®¡æ—¶å™¨ï¼Œæ— ä½¿ç”¨è€…æ—¶è‡ªåŠ¨æ–­å¼€ |

---

## ğŸ“Š è¿æ¥çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> Connecting: åˆ›å»ºè¿æ¥
    
    Connecting --> Active: è®¤è¯æˆåŠŸ
    Connecting --> Error: è®¤è¯å¤±è´¥
    
    Active --> Idle: ref_count = 0
    Idle --> Active: ref_count > 0
    Active --> Active: æ­£å¸¸ä½¿ç”¨
    
    Active --> LinkDown: å¿ƒè·³å¤±è´¥ Ã— 2
    LinkDown --> Reconnecting: è‡ªåŠ¨å¯åŠ¨é‡è¿
    
    Reconnecting --> Active: é‡è¿æˆåŠŸ
    Reconnecting --> Error: è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
    
    Active --> Disconnecting: ç”¨æˆ·ä¸»åŠ¨æ–­å¼€
    Idle --> Disconnecting: ç©ºé—²è¶…æ—¶
    
    Disconnecting --> Disconnected: æ¸…ç†èµ„æº
    Error --> Disconnected
    Disconnected --> [*]
```

### çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | å«ä¹‰ | ref_count |
|------|------|-----------|
| **Connecting** | æ­£åœ¨å»ºç«‹ TCP + SSH æ¡æ‰‹ | 0 |
| **Active** | å·²è¿æ¥ï¼Œæœ‰ä¼šè¯åœ¨ä½¿ç”¨ | > 0 |
| **Idle** | å·²è¿æ¥ï¼Œæ— ä½¿ç”¨è€…ï¼Œç­‰å¾…è¶…æ—¶ | 0 |
| **LinkDown** | å¿ƒè·³å¤±è´¥ï¼Œé“¾è·¯æ–­å¼€ | >= 0 |
| **Reconnecting** | æ­£åœ¨é‡è¿ | >= 0 |
| **Disconnecting** | æ­£åœ¨æ–­å¼€è¿æ¥ | 0 |
| **Disconnected** | å·²æ–­å¼€ | 0 |
| **Error** | è¿æ¥é”™è¯¯ | 0 |

---

## ğŸ”„ å¼•ç”¨è®¡æ•°æœºåˆ¶

### å·¥ä½œåŸç†

æ¯ä¸ªè¿æ¥ç»´æŠ¤ä¸€ä¸ªåŸå­å¼•ç”¨è®¡æ•°å™¨ï¼ˆ`AtomicU32`ï¼‰ï¼Œè®°å½•æœ‰å¤šå°‘ä¸ª"ä½¿ç”¨è€…"ï¼š

```
è¿æ¥åˆ›å»ºæ—¶ï¼šref_count = 0
â”œâ”€â”€ Terminal 1 æ‰“å¼€    â†’ ref_count++  (0 â†’ 1)
â”œâ”€â”€ Terminal 2 æ‰“å¼€    â†’ ref_count++  (1 â†’ 2)
â”œâ”€â”€ SFTP ä¼šè¯æ‰“å¼€      â†’ ref_count++  (2 â†’ 3)
â”œâ”€â”€ ç«¯å£è½¬å‘è§„åˆ™æ·»åŠ    â†’ ref_count++  (3 â†’ 4)
â”‚
â”œâ”€â”€ Terminal 1 å…³é—­    â†’ ref_count--  (4 â†’ 3)
â”œâ”€â”€ Terminal 2 å…³é—­    â†’ ref_count--  (3 â†’ 2)
â”œâ”€â”€ SFTP ä¼šè¯å…³é—­      â†’ ref_count--  (2 â†’ 1)
â””â”€â”€ ç«¯å£è½¬å‘è§„åˆ™åˆ é™¤   â†’ ref_count--  (1 â†’ 0)
     â”‚
     â””â”€â”€ å½’é›¶åè§¦å‘ï¼š
         - state: Active â†’ Idle
         - å¯åŠ¨ç©ºé—²è®¡æ—¶å™¨ï¼ˆé»˜è®¤ 30 åˆ†é’Ÿï¼‰
```

### æ¶ˆè´¹è€…ç±»å‹

| æ¶ˆè´¹è€… | add_ref | release |
|--------|---------|---------|
| **Terminal ä¼šè¯** | åˆ›å»ºç»ˆç«¯æ—¶ | å…³é—­ç»ˆç«¯æ—¶ |
| **SFTP ä¼šè¯** | æ‰“å¼€æ–‡ä»¶æµè§ˆå™¨æ—¶ | å…³é—­æ–‡ä»¶æµè§ˆå™¨æ—¶ |
| **ç«¯å£è½¬å‘** | æ·»åŠ è½¬å‘è§„åˆ™æ—¶ | åˆ é™¤è½¬å‘è§„åˆ™æ—¶ |

---

## ğŸ’“ å¿ƒè·³æ£€æµ‹æœºåˆ¶

### é…ç½®å‚æ•°

```rust
å¿ƒè·³é—´éš” (HEARTBEAT_INTERVAL):    15 ç§’
å¤±è´¥é˜ˆå€¼ (HEARTBEAT_FAIL_THRESHOLD): 2 æ¬¡
æ€»æ£€æµ‹æ—¶é—´ï¼š15s Ã— 2 = 30 ç§’å†…å¿…è§¦å‘é‡è¿
```

### å¿ƒè·³æµç¨‹

```
æ¯ 15 ç§’æ‰§è¡Œä¸€æ¬¡å¿ƒè·³æ£€æµ‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. HandleController.ping()                        â”‚
â”‚     â””â”€â”€ å°è¯•æ‰“å¼€ä¸€ä¸ª SSH session_channel (5sè¶…æ—¶) â”‚
â”‚                                                    â”‚
â”‚  2. æ ¹æ®ç»“æœåˆ†ç±»ï¼š                                 â”‚
â”‚     â”œâ”€â”€ PingResult::Ok                             â”‚
â”‚     â”‚   â†’ reset_heartbeat_failures()               â”‚
â”‚     â”‚   â†’ failures = 0                             â”‚
â”‚     â”‚                                               â”‚
â”‚     â”œâ”€â”€ PingResult::Timeout                        â”‚
â”‚     â”‚   â†’ increment_heartbeat_failures()           â”‚
â”‚     â”‚   â†’ failures++                               â”‚
â”‚     â”‚   â†’ å¦‚æœ failures >= 2ï¼šè§¦å‘ LinkDown        â”‚
â”‚     â”‚                                               â”‚
â”‚     â””â”€â”€ PingResult::IoError                        â”‚
â”‚         â†’ ç«‹å³æ ‡è®°ä¸º LinkDown                      â”‚
â”‚         â†’ ç«‹å³å¯åŠ¨é‡è¿ï¼ˆä¸ç­‰ç¬¬äºŒæ¬¡ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¿ƒè·³æ£€æµ‹çš„å¥½å¤„

- **æ—©æœŸå‘ç°é—®é¢˜**ï¼šä¸ç­‰ç”¨æˆ·è¾“å…¥æ‰å‘ç°è¿æ¥æ–­å¼€
- **ä¸»åŠ¨ä¿æ´»**ï¼šé˜²æ­¢ NAT è¶…æ—¶æˆ–é˜²ç«å¢™æ–­è¿
- **é€æ˜æ¢å¤**ï¼šç”¨æˆ·æ— æ„ŸçŸ¥çš„è‡ªåŠ¨é‡è¿

---

## ğŸ” è‡ªåŠ¨é‡è¿æœºåˆ¶

### é‡è¿ç­–ç•¥

**æŒ‡æ•°é€€é¿ (Exponential Backoff)**ï¼š

```
é¦–æ¬¡é‡è¿ï¼š200ms  (å¿«é€Ÿé¦–è·³ï¼Œç¬æ–­åœºæ™¯è¿‘ä¹æ— æ„Ÿ)
ç¬¬ 2 æ¬¡ï¼š 500ms
ç¬¬ 3 æ¬¡ï¼š 1s
ç¬¬ 4 æ¬¡ï¼š 2s
ç¬¬ 5 æ¬¡ï¼š 4s
...
æœ€å¤§é—´éš”ï¼š60s
æœ€å¤§æ¬¡æ•°ï¼š5 æ¬¡ï¼ˆæ™®é€šæ¨¡å¼ï¼‰
```

### é‡è¿æµç¨‹

```mermaid
sequenceDiagram
    participant HB as Heartbeat Task
    participant Conn as ConnectionEntry
    participant Reg as SshConnectionRegistry
    participant UI as Frontend
    
    Note over HB: å¿ƒè·³å¤±è´¥ Ã— 2
    
    HB->>Conn: set_state(LinkDown)
    HB->>Reg: emit_event("link_down")
    Reg->>UI: connection_status_changed
    Note over UI: æ˜¾ç¤º Input Lock Overlay
    
    HB->>Reg: start_reconnect()
    
    loop é‡è¿å¾ªç¯ (æœ€å¤š 5 æ¬¡)
        Reg->>Reg: connect(config)
        
        alt é‡è¿æˆåŠŸ
            Reg->>Conn: replace_handle_controller()
            Reg->>Conn: set_state(Active)
            Reg->>UI: connection_status_changed("connected")
            Note over UI: ç§»é™¤ Overlayï¼Œæ¢å¤è¾“å…¥
            Reg->>Reg: start_heartbeat()
        else é‡è¿å¤±è´¥
            Reg->>Reg: ç­‰å¾… (200ms, 500ms, 1s, 2s, 4s...)
            Note over Reg: æŒ‡æ•°é€€é¿
        end
    end
    
    alt è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
        Reg->>Conn: set_state(Disconnected)
        Reg->>UI: connection_status_changed("disconnected")
        Note over UI: æ˜¾ç¤ºé”™è¯¯ï¼Œå…è®¸ç”¨æˆ·æ‰‹åŠ¨é‡è¿
    end
```

### é‡è¿è¡Œä¸º

| ç»„ä»¶ | LinkDown è¡Œä¸º | Reconnecting è¡Œä¸º | Connected å |
|------|---------------|-------------------|--------------|
| **Terminal** | è¾“å…¥é”å®šï¼Œæ˜¾ç¤º Input Lock Overlay | ä¿ç•™å†å²è¾“å‡º | ç§»é™¤é”å®šï¼Œæ¢å¤è¾“å…¥ |
| **SFTP** | ä¼ è¾“ä¸­æ–­ï¼Œæ ‡è®°ä¸º error | ç­‰å¾…é‡è¿ | è‡ªåŠ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ |
| **Port Forward** | è½¬å‘æš‚åœ | ç­‰å¾…æ¢å¤ | è‡ªåŠ¨æ¢å¤æ‰€æœ‰è½¬å‘è§„åˆ™ |

---

## â±ï¸ ç©ºé—²è¶…æ—¶æœºåˆ¶

### é…ç½®å‚æ•°

```rust
é»˜è®¤ç©ºé—²è¶…æ—¶ï¼š30 åˆ†é’Ÿ (å¯é…ç½®)
keep_alive æ ‡å¿—ï¼šå¿½ç•¥ç©ºé—²è¶…æ—¶
```

### ç©ºé—²è¶…æ—¶æµç¨‹

```
ref_count å½’é›¶æ—¶ï¼š
â”œâ”€â”€ state: Active â†’ Idle
â”œâ”€â”€ å¯åŠ¨ç©ºé—²è®¡æ—¶å™¨ï¼ˆ30 åˆ†é’Ÿå€’è®¡æ—¶ï¼‰
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  æœŸé—´å¦‚æœ‰æ–°ä½¿ç”¨è€…ï¼š                 â”‚
â”‚  â”‚  â”œâ”€â”€ å–æ¶ˆç©ºé—²è®¡æ—¶å™¨                 â”‚
â”‚  â”‚  â”œâ”€â”€ state: Idle â†’ Active           â”‚
â”‚  â”‚  â””â”€â”€ ref_count++                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â””â”€â”€ 30 åˆ†é’Ÿåæ— æ–°å¼•ç”¨ï¼š
    â”œâ”€â”€ å–æ¶ˆå¿ƒè·³ä»»åŠ¡
    â”œâ”€â”€ å…³é—­ SSH è¿æ¥
    â”œâ”€â”€ state: Idle â†’ Disconnected
    â””â”€â”€ ä»è¿æ¥æ± ä¸­ç§»é™¤
```

### keep_alive æ¨¡å¼

å¦‚æœ `keep_alive = true`ï¼š
- âŒ ä¸å¯åŠ¨ç©ºé—²è®¡æ—¶å™¨
- âœ… å³ä½¿ ref_count = 0 ä¹Ÿä¿æŒè¿æ¥
- âœ… å¿ƒè·³ç»§ç»­è¿è¡Œï¼Œä¿æŒè¿æ¥æ´»è·ƒ
- ç”¨é€”ï¼šéœ€è¦é•¿æœŸä¿æŒè¿æ¥çš„åœºæ™¯ï¼ˆä¾‹å¦‚ï¼šè‡ªåŠ¨åŒ–è„šæœ¬ï¼‰

---

## ğŸ“ˆ è¿æ¥æ± ç»Ÿè®¡

### ç›‘æ§æŒ‡æ ‡

è¿æ¥æ± æä¾›å®æ—¶ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯ç”¨äºç›‘æ§é¢æ¿ï¼š

```typescript
interface ConnectionPoolStats {
  totalConnections: number;         // æ€»è¿æ¥æ•°
  activeConnections: number;         // æ´»è·ƒè¿æ¥æ•° (æœ‰ä½¿ç”¨è€…)
  idleConnections: number;           // ç©ºé—²è¿æ¥æ•° (æ— ä½¿ç”¨è€…ï¼Œç­‰å¾…è¶…æ—¶)
  reconnectingConnections: number;   // é‡è¿ä¸­çš„è¿æ¥æ•°
  linkDownConnections: number;       // é“¾è·¯æ–­å¼€çš„è¿æ¥æ•°
  totalTerminals: number;            // æ€»ç»ˆç«¯æ•°
  totalSftpSessions: number;         // æ€» SFTP ä¼šè¯æ•°
  totalForwards: number;             // æ€»ç«¯å£è½¬å‘æ•°
  totalRefCount: number;             // æ€»å¼•ç”¨è®¡æ•°
  poolCapacity: number;              // è¿æ¥æ± å®¹é‡ (0 = æ— é™åˆ¶)
  idleTimeoutSecs: number;           // ç©ºé—²è¶…æ—¶æ—¶é—´ (ç§’)
}
```

### ä½¿ç”¨ç¤ºä¾‹

```bash
# ç¤ºä¾‹è¾“å‡º
æ€»è¿æ¥æ•°: 5
  â”œâ”€â”€ æ´»è·ƒ: 3
  â”œâ”€â”€ ç©ºé—²: 1
  â”œâ”€â”€ é‡è¿ä¸­: 1
  â””â”€â”€ é“¾è·¯æ–­å¼€: 0

æ€»ä½¿ç”¨è€…: 8
  â”œâ”€â”€ ç»ˆç«¯: 5
  â”œâ”€â”€ SFTP: 2
  â””â”€â”€ ç«¯å£è½¬å‘: 1

æ€»å¼•ç”¨è®¡æ•°: 8
```

---

## ğŸ”’ çº¿ç¨‹å®‰å…¨

### åŸå­æ“ä½œ

è¿æ¥æ± ä½¿ç”¨æ— é”æ•°æ®ç»“æ„ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼š

| å­—æ®µ | ç±»å‹ | ç”¨é€” |
|------|------|------|
| `ref_count` | `AtomicU32` | å¼•ç”¨è®¡æ•° |
| `last_active` | `AtomicU64` | æœ€åæ´»åŠ¨æ—¶é—´æˆ³ |
| `heartbeat_failures` | `AtomicU32` | å¿ƒè·³å¤±è´¥è®¡æ•° |
| `reconnect_attempts` | `AtomicU32` | é‡è¿å°è¯•æ¬¡æ•° |
| `is_reconnecting` | `AtomicBool` | é‡è¿æ ‡å¿— |
| `current_attempt_id` | `AtomicU64` | é‡è¿ä»»åŠ¡ IDï¼ˆé˜²æ­¢æ—§ä»»åŠ¡è¦†ç›–æ–°ä»»åŠ¡ï¼‰ |

### é”ä¿æŠ¤

å¯¹äºéœ€è¦äº’æ–¥çš„æ“ä½œï¼Œä½¿ç”¨ Tokio å¼‚æ­¥é”ï¼š

| å­—æ®µ | ç±»å‹ | ä¿æŠ¤å†…å®¹ |
|------|------|---------|
| `state` | `RwLock<ConnectionState>` | è¿æ¥çŠ¶æ€ |
| `keep_alive` | `RwLock<bool>` | keep_alive æ ‡å¿— |
| `terminal_ids` | `RwLock<Vec<String>>` | å…³è”çš„ç»ˆç«¯ ID |
| `sftp_session_id` | `RwLock<Option<String>>` | å…³è”çš„ SFTP ä¼šè¯ ID |
| `forward_ids` | `RwLock<Vec<String>>` | å…³è”çš„è½¬å‘ ID |
| `idle_timer` | `Mutex<Option<JoinHandle>>` | ç©ºé—²è®¡æ—¶å™¨å¥æŸ„ |
| `heartbeat_task` | `Mutex<Option<JoinHandle>>` | å¿ƒè·³ä»»åŠ¡å¥æŸ„ |
| `reconnect_task` | `Mutex<Option<JoinHandle>>` | é‡è¿ä»»åŠ¡å¥æŸ„ |

---

## ğŸ›ï¸ é…ç½®é€‰é¡¹

### è¿æ¥æ± é…ç½®

```rust
pub struct ConnectionPoolConfig {
    /// ç©ºé—²è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    idle_timeout_secs: u64,  // é»˜è®¤: 1800 (30 åˆ†é’Ÿ)
    
    /// æœ€å¤§è¿æ¥æ•°ï¼ˆ0 = æ— é™åˆ¶ï¼‰
    max_connections: usize,  // é»˜è®¤: 0
    
    /// åº”ç”¨é€€å‡ºæ—¶ä¿æŠ¤è¿æ¥ï¼ˆgraceful shutdownï¼‰
    protect_on_exit: bool,   // é»˜è®¤: true
}
```

### æ›´æ–°é…ç½®

```rust
// è®¾ç½®è‡ªå®šä¹‰é…ç½®
let config = ConnectionPoolConfig {
    idle_timeout_secs: 3600,  // 1 å°æ—¶
    max_connections: 10,       // æœ€å¤š 10 ä¸ªè¿æ¥
    protect_on_exit: true,
};

registry.set_config(config).await;
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. DashMap æ— é”å¹¶å‘

```rust
// ä½¿ç”¨ DashMap æ›¿ä»£ RwLock<HashMap>
connections: DashMap<String, Arc<ConnectionEntry>>
```

**ä¼˜åŠ¿**ï¼š
- âœ… è¯»æ“ä½œæ— éœ€å…¨å±€é”
- âœ… å†™æ“ä½œä»…é”å®šå•ä¸ªåˆ†ç‰‡
- âœ… é«˜å¹¶å‘åœºæ™¯æ€§èƒ½ä¼˜ç§€

### 2. åŸå­æ“ä½œ

```rust
// æ— é”å¼•ç”¨è®¡æ•°
ref_count.fetch_add(1, Ordering::SeqCst);
ref_count.fetch_sub(1, Ordering::SeqCst);
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ— é”äº‰ç”¨
- âœ… CPU åŸå­æŒ‡ä»¤ï¼Œæä½å¼€é”€

### 3. å¼‚æ­¥ä»»åŠ¡éš”ç¦»

```rust
// å¿ƒè·³ä»»åŠ¡ç‹¬ç«‹è¿è¡Œ
tokio::spawn(async move { /* heartbeat loop */ });

// é‡è¿ä»»åŠ¡ç‹¬ç«‹è¿è¡Œ
tokio::spawn(async move { /* reconnect loop */ });
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸é˜»å¡ä¸»äº‹ä»¶å¾ªç¯
- âœ… ä»»åŠ¡å¯ç‹¬ç«‹å–æ¶ˆ

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

### é”™è¯¯ç±»å‹

```rust
pub enum ConnectionRegistryError {
    NotFound(String),                      // è¿æ¥ä¸å­˜åœ¨
    LimitReached { current: usize, max: usize },  // è¾¾åˆ°è¿æ¥æ•°ä¸Šé™
    ConnectionFailed(String),              // è¿æ¥å¤±è´¥
    AlreadyDisconnected,                   // å·²æ–­å¼€
    InvalidState(String),                  // æ— æ•ˆçŠ¶æ€è½¬æ¢
}
```

### é”™è¯¯æ¢å¤ç­–ç•¥

| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ |
|---------|---------|
| **ç½‘ç»œæ–­å¼€** | è‡ªåŠ¨é‡è¿ï¼ˆæœ€å¤š 5 æ¬¡ï¼‰ |
| **è®¤è¯å¤±è´¥** | æ ‡è®°ä¸º Errorï¼Œé€šçŸ¥ç”¨æˆ· |
| **è¿æ¥æ•°è¶…é™** | æ‹’ç»æ–°è¿æ¥ï¼Œæç¤ºç”¨æˆ· |
| **å¿ƒè·³è¶…æ—¶** | æ ‡è®°ä¸º LinkDownï¼Œå¯åŠ¨é‡è¿ |

---

## ğŸ“š ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºè¿æ¥

```rust
let config = SessionConfig::with_password(
    "prod.example.com",
    22,
    "admin",
    "password123"
);

let connection_id = registry.connect(config).await?;
```

### è·å–å¥æŸ„å¹¶ä½¿ç”¨

```rust
// è·å–è¿æ¥
let entry = registry.get(&connection_id)?;

// å¢åŠ å¼•ç”¨è®¡æ•°
entry.add_ref();

// å…‹éš† HandleController
let handle = entry.handle_controller.clone();

// æ‰“å¼€æ–° channel
let channel = handle.open_session_channel().await?;

// ä½¿ç”¨å®Œæ¯•åé‡Šæ”¾
entry.release();
```

### æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```rust
let stats = registry.get_stats().await;
println!("æ€»è¿æ¥æ•°: {}", stats.total_connections);
println!("æ´»è·ƒè¿æ¥æ•°: {}", stats.active_connections);
println!("æ€»å¼•ç”¨è®¡æ•°: {}", stats.total_ref_count);
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### Q: è¿æ¥æ€»æ˜¯åœ¨ 30 åˆ†é’Ÿåæ–­å¼€ï¼Ÿ

A: è¿™æ˜¯æ­£å¸¸çš„ç©ºé—²è¶…æ—¶è¡Œä¸ºã€‚å¦‚æœéœ€è¦ä¿æŒè¿æ¥ï¼š
1. è®¾ç½® `keep_alive = true`
2. æˆ–å¢å¤§ `idle_timeout_secs` é…ç½®

### Q: å¿ƒè·³é¢‘ç¹å¤±è´¥ä½†ç½‘ç»œæ­£å¸¸ï¼Ÿ

A: å¯èƒ½çš„åŸå› ï¼š
- æœåŠ¡å™¨é™åˆ¶äº†å¹¶å‘ session æ•°
- é˜²ç«å¢™é˜»æ­¢äº†æŸäº›ç«¯å£
- æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜

å»ºè®®ï¼šå¢å¤§å¿ƒè·³é—´éš”æˆ–ç¦ç”¨å¿ƒè·³

### Q: é‡è¿æ€»æ˜¯å¤±è´¥ï¼Ÿ

A: æ£€æŸ¥ï¼š
- è®¤è¯ä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼ˆå¯†é’¥æ˜¯å¦è¿‡æœŸï¼‰
- ç½‘ç»œæ˜¯å¦ç¨³å®š
- æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿
- æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.1.0 | æœ€åæ›´æ–°: 2026-01-19*
