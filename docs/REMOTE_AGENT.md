# è¿œç¨‹ä»£ç† (Remote Agent)

> OxideTerm å¯ä»¥å°†ä¸€ä¸ªè½»é‡çº§ä»£ç†ç¨‹åºè‡ªåŠ¨éƒ¨ç½²åˆ°è¿œç¨‹ Linux ä¸»æœºï¼Œæ˜¾è‘—æå‡ IDE æ¨¡å¼ä¸‹çš„æ–‡ä»¶æ“ä½œæ€§èƒ½å’Œä½“éªŒã€‚

## æ¦‚è¿°

OxideTerm Agent æ˜¯ä¸€ä¸ªæ— ä¾èµ–ã€é™æ€é“¾æ¥çš„ Rust å•ä½“äºŒè¿›åˆ¶ï¼ˆ~600 KBï¼‰ï¼Œé€šè¿‡ SSH é€šé“ä¸ä¸»åº”ç”¨é€šä¿¡ã€‚å®ƒç›´æ¥åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œæ–‡ä»¶æ“ä½œï¼Œé¿å…äº†ä¼ ç»Ÿ SFTP æ–¹æ¡ˆçš„é€æ¡å¾€è¿”å»¶è¿Ÿã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **åŸå­æ–‡ä»¶å†™å…¥** â€” å…ˆå†™ä¸´æ—¶æ–‡ä»¶å† renameï¼Œç½‘ç»œä¸­æ–­ä¸ä¼šäº§ç”ŸåŠæˆå“æ–‡ä»¶
- **inotify å®æ—¶ç›‘è§†** â€” æ–‡ä»¶åœ¨è¿œç«¯è¢«ä¿®æ”¹æ—¶ï¼ŒIDE å†…å³æ—¶åˆ·æ–°ï¼ˆæ— éœ€è½®è¯¢ï¼‰
- **å“ˆå¸Œå†²çªæ£€æµ‹** â€” å†™å…¥å‰æ ¡éªŒ SHA-256ï¼Œé˜²æ­¢è¦†ç›–å¤–éƒ¨ä¿®æ”¹
- **æœåŠ¡å™¨ç«¯æœç´¢** â€” grep ç›´æ¥åœ¨è¿œç«¯æ‰§è¡Œï¼Œä»…ä¼ å›åŒ¹é…ç»“æœ
- **æ·±å±‚ç›®å½•æ ‘é¢„å–** â€” ä¸€æ¬¡è¯·æ±‚è·å– 3 å±‚ç›®å½•ç»“æ„ï¼Œå‡å°‘å±•å¼€ç­‰å¾…

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OxideTerm åº”ç”¨ (Tauri + React)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ IDE å‰ç«¯ç»„ä»¶  â”‚    â”‚  Rust åç«¯                            â”‚ â”‚
â”‚  â”‚  IdeTree     â”‚â—„â”€â”€â–ºâ”‚  AgentTransport (stdin/stdout)      â”‚ â”‚
â”‚  â”‚  IdeEditor   â”‚    â”‚  AgentDeployer (è‡ªåŠ¨éƒ¨ç½²)              â”‚ â”‚
â”‚  â”‚  IdeSearch   â”‚    â”‚  AgentRegistry (å¤šä¼šè¯ç®¡ç†)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ SSH exec é€šé“
                                     â”‚ (stdin/stdout JSON-RPC)
                                     â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  è¿œç¨‹ Linux ä¸»æœº       â”‚
                          â”‚  ~/.oxideterm/         â”‚
                          â”‚    oxideterm-agent     â”‚
                          â”‚    (é™æ€ musl äºŒè¿›åˆ¶)    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é€šä¿¡åè®®

Agent ä½¿ç”¨ **è¡Œåˆ†éš” JSON-RPC** åè®®ï¼Œé€šè¿‡ SSH exec é€šé“çš„ stdin/stdout ä¼ è¾“ã€‚

### è¯·æ±‚æ ¼å¼

```json
{"id": 1, "method": "fs/readFile", "params": {"path": "/home/user/example.txt"}}
```

### å“åº”æ ¼å¼

```json
{"id": 1, "result": {"content": "file content...", "hash": "sha256:abc123..."}}
```

### é”™è¯¯å“åº”

```json
{"id": 1, "error": {"code": -2, "message": "File not found: /path/to/file"}}
```

### é€šçŸ¥ï¼ˆæœåŠ¡ç«¯ä¸»åŠ¨æ¨é€ï¼‰

```json
{"method": "watch/event", "params": {"path": "/home/user/file.txt", "kind": "modify"}}
```

## æ”¯æŒçš„æ–¹æ³•

### æ–‡ä»¶ç³»ç»Ÿæ“ä½œ (`fs/*`)

| æ–¹æ³• | è¯´æ˜ | å‚æ•° |
|------|------|------|
| `fs/readFile` | è¯»å–æ–‡ä»¶å†…å®¹ | `path`, `max_size?` |
| `fs/writeFile` | åŸå­å†™å…¥æ–‡ä»¶ | `path`, `content`, `expected_hash?` |
| `fs/stat` | è·å–æ–‡ä»¶å…ƒä¿¡æ¯ | `path` |
| `fs/list` | åˆ—å‡ºç›®å½•å†…å®¹ | `path` |
| `fs/listTree` | é€’å½’è·å–ç›®å½•æ ‘ | `path`, `depth?`, `max_entries?` |
| `fs/mkdir` | åˆ›å»ºç›®å½• | `path` |
| `fs/remove` | åˆ é™¤æ–‡ä»¶æˆ–ç›®å½• | `path`, `recursive?` |
| `fs/rename` | é‡å‘½å/ç§»åŠ¨ | `from`, `to` |

### æœç´¢æ“ä½œ (`search/*`)

| æ–¹æ³• | è¯´æ˜ | å‚æ•° |
|------|------|------|
| `search/grep` | åœ¨æ–‡ä»¶/ç›®å½•ä¸­æœç´¢æ–‡æœ¬ | `pattern`, `path`, `case_sensitive?`, `max_results?`, `ignore?` |

### æ–‡ä»¶ç›‘è§† (`watch/*`)

| æ–¹æ³• | è¯´æ˜ | å‚æ•° |
|------|------|------|
| `watch/start` | å¼€å§‹ç›‘è§†ç›®å½•å˜æ›´ | `path`, `ignore?` |
| `watch/stop` | åœæ­¢ç›‘è§† | `path` |

### ç³»ç»Ÿæ“ä½œ (`sys/*`)

| æ–¹æ³• | è¯´æ˜ | å‚æ•° |
|------|------|------|
| `sys/info` | è¿”å› Agent ç‰ˆæœ¬å’Œç³»ç»Ÿä¿¡æ¯ | æ—  |
| `sys/shutdown` | ä¼˜é›…å…³é—­ Agent è¿›ç¨‹ | æ—  |

## éƒ¨ç½²æµç¨‹

Agent çš„éƒ¨ç½²å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨æ“ä½œï¼š

```
1. æ£€æµ‹è¿œç¨‹æ¶æ„ â”€â”€â–º uname -m
2. ç‰ˆæœ¬æ£€æŸ¥     â”€â”€â–º è¿è¡Œ oxideterm-agent --version (å¦‚å·²å­˜åœ¨)
3. ä¸Šä¼ äºŒè¿›åˆ¶   â”€â”€â–º é€šè¿‡ SFTP ä¼ è¾“åˆ° ~/.oxideterm/oxideterm-agent
4. è®¾ç½®æƒé™     â”€â”€â–º chmod +x
5. å¯åŠ¨ä»£ç†     â”€â”€â–º SSH exec é€šé“æ‰§è¡Œ
6. æ¡æ‰‹éªŒè¯     â”€â”€â–º å‘é€ sys/info ç¡®è®¤é€šä¿¡æ­£å¸¸
```

å¦‚æœç‰ˆæœ¬ä¸€è‡´ï¼Œè·³è¿‡æ­¥éª¤ 3-4ï¼Œç›´æ¥å¯åŠ¨ã€‚

### æ”¯æŒçš„ç›®æ ‡æ¶æ„

| æ¶æ„ | äºŒè¿›åˆ¶æ–‡ä»¶å | å¤§å° |
|------|-------------|------|
| x86_64 (Intel/AMD) | `oxideterm-agent-x86_64-linux-musl` | ~670 KB |
| aarch64 (ARM64) | `oxideterm-agent-aarch64-linux-musl` | ~600 KB |

ä¸æ”¯æŒçš„æ¶æ„ï¼ˆå¦‚ 32 ä½ ARMã€MIPS ç­‰ï¼‰ä¼šè‡ªåŠ¨å›é€€åˆ° SFTP æ¨¡å¼ã€‚

## å®‰å…¨æ€§

- **è¿›ç¨‹éš”ç¦»** â€” Agent ä»¥å½“å‰ SSH ç”¨æˆ·æƒé™è¿è¡Œï¼Œæ—  root ææƒ
- **è‡ªæ¸…ç†** â€” SSH è¿æ¥æ–­å¼€æ—¶ stdin EOF è§¦å‘è‡ªåŠ¨é€€å‡º
- **æ— ç½‘ç»œç›‘å¬** â€” ä¸å¼€æ”¾ä»»ä½•ç«¯å£ï¼Œä»…é€šè¿‡ SSH é€šé“é€šä¿¡
- **æœ€å°æƒé™** â€” ä»…è®¿é—®ç”¨æˆ·æœ‰æƒé™çš„æ–‡ä»¶
- **é™æ€é“¾æ¥** â€” ä¸ä¾èµ–ç›®æ ‡ç³»ç»Ÿçš„å…±äº«åº“

## è®¾è®¡åŸåˆ™

1. **é›¶å¼‚æ­¥è¿è¡Œæ—¶** â€” ä¸ä½¿ç”¨ tokioï¼Œä»… `std::thread` + é˜»å¡ I/Oï¼Œæœ€å°åŒ–äºŒè¿›åˆ¶ä½“ç§¯
2. **æœ€å°‘ä¾èµ–** â€” åªæœ‰ `serde`ã€`serde_json`ã€`inotify`ï¼ˆLinuxï¼‰ã€`libc`
3. **é™æ€ musl é“¾æ¥** â€” åœ¨ä»»ä½• Linux å‘è¡Œç‰ˆä¸Šæ— éœ€å®‰è£…ä¾èµ–å³å¯è¿è¡Œ
4. **ä¼˜é›…é™çº§** â€” å¦‚æœéƒ¨ç½²å¤±è´¥æˆ–æ¶æ„ä¸æ”¯æŒï¼Œè‡ªåŠ¨å›é€€åˆ° SFTPï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨

## åŸå­å†™å…¥æœºåˆ¶

ä¼ ç»Ÿ SFTP å†™å…¥åœ¨ç½‘ç»œä¸­æ–­æ—¶å¯èƒ½äº§ç”Ÿä¸å®Œæ•´æ–‡ä»¶ã€‚Agent ä½¿ç”¨åŸå­å†™å…¥é¿å…æ­¤é—®é¢˜ï¼š

```
1. å†™å…¥ä¸´æ—¶æ–‡ä»¶    â”€â”€â–º /path/to/.file.tmp.{random}
2. éªŒè¯å†…å®¹å®Œæ•´    â”€â”€â–º æ£€æŸ¥å†™å…¥å­—èŠ‚æ•°
3. åŸå­æ›¿æ¢       â”€â”€â–º rename(tmp, target)  â† æ“ä½œç³»ç»Ÿä¿è¯åŸå­æ€§
```

å¦‚æœå®¢æˆ·ç«¯è¿˜æä¾›äº† `expected_hash`ï¼ˆä¹‹å‰è¯»å–æ—¶è·å¾—çš„ SHA-256ï¼‰ï¼ŒAgent ä¼šåœ¨å†™å…¥å‰æ£€æŸ¥ç›®æ ‡æ–‡ä»¶çš„å½“å‰å“ˆå¸Œã€‚å¦‚æœä¸ä¸€è‡´ï¼Œè¯´æ˜æ–‡ä»¶åœ¨æ­¤æœŸé—´è¢«å¤–éƒ¨ä¿®æ”¹ï¼Œå†™å…¥å°†è¢«æ‹’ç»å¹¶è¿”å›å†²çªé”™è¯¯ã€‚

## inotify æ–‡ä»¶ç›‘è§†

åœ¨ Linux ä¸Šï¼ŒAgent ä½¿ç”¨å†…æ ¸çš„ inotify æœºåˆ¶å®ç°é›¶å»¶è¿Ÿæ–‡ä»¶ç›‘è§†ï¼š

- é€’å½’ç›‘è§†æ‰€æœ‰å­ç›®å½•ï¼ˆè‡ªåŠ¨æ·»åŠ æ–°ç›®å½•ï¼‰
- æ”¯æŒ `.gitignore` é£æ ¼çš„æ’é™¤æ¨¡å¼
- inotify æ–‡ä»¶æè¿°ç¬¦è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œç¡®ä¿åœæ­¢ä¿¡å·å¯åŠæ—¶å“åº”
- é Linux ç³»ç»Ÿä¸æ”¯æŒæ–‡ä»¶ç›‘è§†ï¼ˆæ­¤åŠŸèƒ½ä»…åœ¨è¿œç¨‹ä¸»æœºä¸º Linux æ—¶å¯ç”¨ï¼‰

## æ„å»º

### å‰ç½®æ¡ä»¶

```bash
# å®‰è£… musl äº¤å‰ç¼–è¯‘ç›®æ ‡
rustup target add x86_64-unknown-linux-musl aarch64-unknown-linux-musl

# macOS éœ€è¦å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾
brew install filosottile/musl-cross/musl-cross
brew install messense/macos-cross-toolchains/aarch64-unknown-linux-musl

# æˆ–è€…ä½¿ç”¨ crossï¼ˆéœ€è¦ Dockerï¼‰
cargo install cross
```

### æ‰‹åŠ¨æ„å»º

```bash
# æ„å»ºä¸¤ä¸ªæ¶æ„
./scripts/build-agent.sh

# åªæ„å»º x86_64
./scripts/build-agent.sh x86_64

# ä½¿ç”¨ cross æ„å»ºï¼ˆéœ€è¦ Docker è¿è¡Œï¼‰
USE_CROSS=1 ./scripts/build-agent.sh
```

æ„å»ºäº§ç‰©è¾“å‡ºåˆ° `src-tauri/agents/`ã€‚

### CI è‡ªåŠ¨æ„å»º

åœ¨ GitHub Actions ä¸­ï¼ŒAgent åœ¨ `ubuntu-24.04` runner ä¸Šè‡ªåŠ¨äº¤å‰ç¼–è¯‘ï¼š

1. x86_64 â€” åŸç”Ÿç¼–è¯‘ï¼ˆrunner å³ä¸º x86_64)
2. aarch64 â€” é€šè¿‡ `cross`ï¼ˆåŸºäº Dockerï¼‰äº¤å‰ç¼–è¯‘
3. ç¼–è¯‘äº§ç‰©å¤åˆ¶åˆ° `src-tauri/agents/` ä¾› Tauri æ‰“åŒ…

macOS å’Œ Windows æ„å»ºä½¿ç”¨ç©ºå ä½æ–‡ä»¶ï¼ˆAgent ä»…åœ¨è¿œç«¯ Linux ä¸»æœºè¿è¡Œï¼Œå®¢æˆ·ç«¯å¹³å°ä¸éœ€è¦æœ¬åœ°è¿è¡Œï¼‰ã€‚

## å‰ç«¯é›†æˆ

### çŠ¶æ€æŒ‡ç¤º

IDE æ¨¡å¼ä¸‹ï¼ŒçŠ¶æ€æ å·¦ä¾§æ˜¾ç¤ºå½“å‰ä¼ è¾“æ¨¡å¼ï¼š

- ğŸŸ¢ **Agent** â€” Agent å·²è¿æ¥ï¼Œäº«å—å…¨éƒ¨å¢å¼ºåŠŸèƒ½
- ğŸŸ¡ **Deploying** â€” æ­£åœ¨éƒ¨ç½² Agent åˆ°è¿œç¨‹ä¸»æœº
- âšª **SFTP** â€” ä½¿ç”¨ä¼ ç»Ÿ SFTPï¼ˆAgent ä¸å¯ç”¨æˆ–æ¶æ„ä¸æ”¯æŒï¼‰

### agentService é—¨é¢

å‰ç«¯é€šè¿‡ `src/lib/agentService.ts` é—¨é¢å±‚è®¿é—® Agent åŠŸèƒ½ï¼š

```typescript
import * as agentService from '@/lib/agentService';

// è¯»å–æ–‡ä»¶ï¼ˆè‡ªåŠ¨é€‰æ‹© Agent æˆ– SFTPï¼‰
const content = await agentService.readFile(nodeId, '/path/to/file');

// åŸå­å†™å…¥
await agentService.writeFile(nodeId, '/path/to/file', content, expectedHash);

// æœç´¢
const results = await agentService.grep(nodeId, 'pattern', '/path', options);

// è·å–ç›®å½•æ ‘ï¼ˆæ·±åº¦é¢„å–ï¼‰
const tree = await agentService.listTree(nodeId, '/root', depth);
```

### æ·±å±‚ç›®å½•é¢„å–

æ‰“å¼€ IDE æ–‡ä»¶æ ‘æ—¶ï¼Œè‡ªåŠ¨åœ¨åå°é¢„å– 3 å±‚ç›®å½•ç»“æ„ï¼Œç¼“å­˜åœ¨ `PrefetchCacheContext` ä¸­ã€‚å±•å¼€å­ç›®å½•æ—¶ä¼˜å…ˆä»ç¼“å­˜è¯»å–ï¼Œæ¶ˆé™¤ç½‘ç»œå»¶è¿Ÿã€‚

## æ•…éšœæ’æŸ¥

| ç—‡çŠ¶ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| çŠ¶æ€æ å§‹ç»ˆæ˜¾ç¤º SFTP | æ¶æ„ä¸æ”¯æŒï¼ˆé x86_64/aarch64 Linuxï¼‰ | æ­£å¸¸è¡Œä¸ºï¼Œæ— éœ€å¤„ç† |
| éƒ¨ç½²åç«‹å³å¤±è´¥ | SELinux æˆ– noexec æŒ‚è½½ç‚¹ | æ£€æŸ¥ `~/.oxideterm/` æ‰€åœ¨åˆ†åŒºæƒé™ |
| æ–‡ä»¶ç›‘è§†ä¸å·¥ä½œ | inotify watch æ•°é‡è¾¾åˆ°ç³»ç»Ÿé™åˆ¶ | å¢å¤§ `fs.inotify.max_user_watches` |
| Agent æœªè‡ªåŠ¨é€€å‡º | SSH è¿æ¥æœªæ­£å¸¸å…³é—­ | Agent ä¼šåœ¨ stdin EOF åè‡ªåŠ¨é€€å‡º |

## ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„](ARCHITECTURE.md) â€” æ•´ä½“æ¶æ„è®¾è®¡
- [IDE æ¨¡å¼](IDE_MODE.md) â€” IDE åŠŸèƒ½è¯¦è§£
- [SFTP å®ç°](SFTP.md) â€” SFTP å›é€€æ–¹æ¡ˆ
- [ç³»ç»Ÿä¸å˜é‡](SYSTEM_INVARIANTS.md) â€” çŠ¶æ€ä¸€è‡´æ€§è§„åˆ™
